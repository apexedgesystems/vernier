# ==============================================================================
# Release -- Build artifacts and publish to GitHub Releases
#
# Triggered by pushing a version tag (v*). Builds all platform artifacts
# through the full Docker pipeline and attaches them to the GitHub Release.
# ==============================================================================
name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Prepare environment
        run: |
          touch ~/.gitconfig
          mkdir -p ~/.ssh

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Verify version matches CMakeLists.txt
        run: |
          cmake_version=$(sed -n 's/.*VERSION \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/p' \
            CMakeLists.txt | head -1)
          tag_version="${{ steps.version.outputs.version }}"
          if [ "$cmake_version" != "$tag_version" ]; then
            echo "ERROR: Tag version ($tag_version) does not match CMakeLists.txt ($cmake_version)"
            exit 1
          fi
          echo "Version verified: $tag_version"

      - name: Build all artifacts
        run: make artifacts

      - name: List artifacts
        run: ls -la output/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Vernier ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            output/vernier-${{ steps.version.outputs.version }}-x86_64-linux.tar.gz
            output/vernier-${{ steps.version.outputs.version }}-x86_64-linux-cuda.tar.gz
            output/vernier-${{ steps.version.outputs.version }}-aarch64-jetson.tar.gz
            output/vernier-${{ steps.version.outputs.version }}-aarch64-rpi.tar.gz
            output/vernier-${{ steps.version.outputs.version }}-riscv64-linux.tar.gz
            output/vernier-tools-${{ steps.version.outputs.version }}-x86_64-linux.tar.gz
            output/vernier_py_tools-${{ steps.version.outputs.version }}-py3-none-any.whl
